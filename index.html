<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GridWatch ‚Äî Report + NOAA + NOVEC Services</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/dark/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    :root { --bg:#0b1220; --panel:#131b2e; --muted:#94a3b8; --accent:#22d3ee; --text:#e2e8f0; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    a{color:var(--accent);text-decoration:none}
    .app{display:grid;grid-template-rows:auto 1fr;height:100%}
    header{display:flex;gap:16px;align-items:center;padding:12px 16px;border-bottom:1px solid #1f263a;background:linear-gradient(180deg,#0f172a,#0b1220)}
    header h1{margin:0;font-size:18px;letter-spacing:.4px}
    .badge{padding:2px 8px;background:#1f2937;color:var(--muted);border-radius:999px;font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#0f172a;border:1px solid #1f263a;border-radius:999px;font-size:12px;color:#cbd5e1}
    .layout{display:grid;grid-template-columns:380px 1fr;gap:14px;padding:14px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid #1f263a;border-radius:14px;overflow:hidden}
    .panel header{display:flex;align-items:center;justify-content:space-between;background:transparent;border:0;padding:12px 14px}
    .panel header h2{margin:0;font-size:15px;color:#cbd5e1}
    .panel .body{padding:0 14px 14px}
    .form-embed{width:100%;height:520px;border:0;border-top:1px solid #1f263a}
    .filters{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 14px}
    .filters label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .filters select,.filters input[type="date"]{width:100%;padding:10px 12px;background:#0f172a;color:var(--text);border:1px solid #1f263a;border-radius:10px}
    .filters button{padding:10px 12px;border:1px solid #1f263a;background:#0f172a;color:var(--text);border-radius:10px;cursor:pointer}
    .filters button:hover{border-color:#334155}
    #viewDiv{width:100%;height:100%;min-height:640px;border:1px solid #1f263a;border-radius:14px;overflow:hidden;position:relative}
    .legend-box{position:absolute;right:12px;bottom:12px;padding:10px 12px;background:#0f172aDD;border:1px solid #1f263a;border-radius:12px;color:#cbd5e1;z-index:5;backdrop-filter:blur(4px)}
    .legend-box h3{margin:0 0 6px;font-size:12px;color:#94a3b8;font-weight:600}
    .note{color:var(--muted);font-size:12px;margin-top:8px}
    .wxBox{border-radius:12px;padding:10px;border:1px solid #1f263a;background:#0f172a}
    .status { margin:8px 14px 0; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0f172a; font-size:12px; color:#cbd5e1; display:none }
    .status.error { border-color:#b91c1c; background:#7f1d1d33; color:#fecaca }
    .status.warn  { border-color:#b45309; background:#78350f33; color:#fde68a }

    /* Compact square visibility switcher (sits beside zoom) */
    .vis-switch {
      position:absolute; top:12px; left:56px; /* beside default zoom (top-left) */
      display:flex; gap:6px; padding:6px;
      background:#0f172a; border:1px solid #1f263a; border-radius:12px;
      z-index: 10;
    }
    .vis-switch button {
      width:34px; height:34px; border-radius:8px; border:1px solid #1f263a;
      background:#0b1220; color:#cbd5e1; cursor:pointer; font-weight:700; font-size:12px;
    }
    .vis-switch button.on {
      background: #22d3ee22; border-color:#22d3ee; color:#e2e8f0;
    }
    .vis-switch button:focus { outline: 2px solid #22d3ee55; outline-offset: 2px; }
    @media (max-width: 520px) {
      .vis-switch { left: 54px; gap:4px; padding:4px; }
      .vis-switch button { width:30px; height:30px; font-size:11px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>‚ö° GridWatch</h1>
      <span class="badge">Report + NOAA + NOVEC Services</span>
      <span class="pill">OSM basemap</span>
    </header>

    <div class="layout">
      <!-- LEFT: Report + Filters + Weather -->
      <section class="panel" aria-label="Report & Filters">
        <header>
          <h2>Report an issue</h2>
          <a id="openForm" href="#" target="_blank">open in new tab ‚Üó</a>
        </header>
        <iframe id="s123" class="form-embed" title="Survey123 form"></iframe>
        <div class="body">
          <h2 style="margin:14px 0 6px;font-size:15px;color:#cbd5e1;">Map filters</h2>
          <div class="filters">
            <div>
              <label for="typeSel">Type</label>
              <select id="typeSel">
                <option value="">All</option>
                <option>Outage</option>
                <option>Voltage spike</option>
                <option>Damaged line</option>
                <option>Tree on line</option>
              </select>
            </div>
            <div>
              <label for="statusSel">Status</label>
              <select id="statusSel">
                <option value="">All</option>
                <option>New</option>
                <option>In progress</option>
                <option>Resolved</option>
              </select>
            </div>
            <div>
              <label for="dateSel">Since (date)</label>
              <input id="dateSel" type="date" />
            </div>
            <div style="display:flex;gap:8px;align-items:end;">
              <button id="applyBtn">Apply</button>
              <button id="resetBtn">Reset</button>
            </div>
          </div>

          <h2 style="margin:14px 0 6px;font-size:15px;color:#cbd5e1;">Weather (NOAA)</h2>
          <p class="note">Click anywhere on the map to fetch a local NWS forecast.</p>
          <div id="wxBox" class="wxBox">
            <div id="wxSummary">No location selected.</div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Map -->
      <section class="panel" aria-label="Map">
        <header>
          <h2>Live reports</h2>
          <span class="pill" id="countPill">0 features</span>
        </header>
        <div id="statusBar" class="status"></div>
        <div id="viewDiv"></div>
        <div class="legend-box">
          <h3>Legend</h3>
          <div>‚óè Outage</div>
          <div>‚óè Voltage spike</div>
          <div>‚óè Damaged line</div>
          <div>‚óè Tree on line</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ==========================
    // üîß CONFIG ‚Äî YOUR LINKS
    // ==========================
    const CONFIG = {
      // Survey123 web form URL
      survey123Url: "https://survey123.arcgis.com/share/dbec98d452884e3ca51548ab0ca97c1f?hide=navbar,header",
      // Survey123 feature layer (layer 0 = points)
      featureLayerUrl: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/survey123_dbec98d452884e3ca51548ab0ca97c1f_form/FeatureServer/0",
      // Field names (match your schema)
      fields: { type: "type", status: "status", created: "CreationDate" },
      // Feeds / overlays
      nwsAlertsUrl: "https://api.weather.gov/alerts/active?status=actual&message_type=alert",
      novecLayerUrl: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/drive_download_20250623T221527Z_1_001/FeatureServer/0",
      // Initial view (NOVEC)
      view: { center: [-77.4, 38.8], zoom: 10 }
    };

    // Set Survey123 iframe + link
    const s123 = document.getElementById('s123');
    const openForm = document.getElementById('openForm');
    s123.src = CONFIG.survey123Url;
    openForm.href = CONFIG.survey123Url;

    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/layers/GeoJSONLayer",
      "esri/widgets/Search",
      "esri/widgets/BasemapToggle"
    ], function(Map, MapView, FeatureLayer, GeoJSONLayer, Search, BasemapToggle) {

      // ===== Status helpers =====
      const statusBar = document.getElementById('statusBar');
      function showStatus(msg, type='warn'){
        statusBar.textContent = msg;
        statusBar.className = 'status ' + (type||'');
        statusBar.style.display = 'block';
      }
      function hideStatus(){ statusBar.style.display='none'; }

      // ===== Field Reports (Survey123) =====
      const reportsLayer = new FeatureLayer({
        url: CONFIG.featureLayerUrl,
        outFields: ["*"],
        popupEnabled: true,
        featureReduction: { type: "cluster" },
        title: "Field Reports",
        popupTemplate: {
          title: `{${CONFIG.fields.type}} ‚Äî {${CONFIG.fields.status}}`,
          content: [
            { type: "fields", fieldInfos: [
              { fieldName: CONFIG.fields.type, label: "Type" },
              { fieldName: CONFIG.fields.status, label: "Status" },
              { fieldName: CONFIG.fields.created, label: "Created" }
            ]},
            { type: "text", text: "<em>Submitted via Survey123</em>" }
          ]
        }
      });

      // ===== NOVEC boundary (visible at all scales + diagnostics) =====
      const novec = new FeatureLayer({
        url: CONFIG.novecLayerUrl,
        title: "NOVEC Territory",
        opacity: 0.25,
        minScale: 0,  // visible at any zoom in
        maxScale: 0,  // visible at any zoom out
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-fill",
            color: [56, 189, 248, 0.15],
            outline: { color: [56, 189, 248, 0.9], width: 1.2 }
          }
        },
        popupTemplate: { title: "Service Territory", content: "{*}" },
        visible: true
      });

      // ===== NWS active alerts =====
      const nwsAlerts = new GeoJSONLayer({
        url: CONFIG.nwsAlertsUrl,
        title: "NWS Alerts",
        visible: false,
        popupTemplate: {
          title: "{event}",
          content: "{headline}<br><small>{effective} ‚Üí {ends}</small>"
        }
      });

      // ===== Map & View =====
      const map = new Map({ basemap: "osm", layers: [reportsLayer, novec, nwsAlerts] });
      const view = new MapView({ container: "viewDiv", map, center: CONFIG.view.center, zoom: CONFIG.view.zoom });

      // Widgets
      view.ui.add(new Search({ view }), "top-right");
      view.ui.add(new BasemapToggle({ view, nextBasemap: "satellite" }), "top-right");

      // ===== Diagnostics: load & layerview errors =====
      reportsLayer.load().catch(e => { showStatus(hintFromError(e, 'Field Reports'), 'error'); console.error('Reports layer load error:', e); });
      novec.load().then(() => {
        const q = novec.createQuery(); q.where = "1=1"; q.returnGeometry = false;
        novec.queryFeatureCount(q).then(c => {
          console.info("NOVEC feature count:", c);
          if (c === 0) showStatus("NOVEC layer has 0 features (check your published shapefile).", "warn");
        });
      }).catch(e => { showStatus(hintFromError(e, 'NOVEC Territory'), 'error'); console.error('NOVEC layer load error:', e); });

      reportsLayer.on("layerview-create-error", (e) => { showStatus(hintFromError(e.error || e, 'Field Reports'), 'error'); console.error("Reports layerview-create-error:", e); });
      novec.on("layerview-create-error", (e) => { showStatus(hintFromError(e.error || e, 'NOVEC Territory'), 'error'); console.error("NOVEC layerview-create-error:", e); });

      function hintFromError(err, layerName){
        const code = (err && (err.code || err.httpStatus || err.status)) || '';
        if (code===498 || code===499 || code===403) {
          return `${layerName}: authentication required (HTTP ${code}). In ArcGIS Online, open the layer item and Share ‚Üí Everyone (public), or add OAuth.`;
        }
        return `${layerName}: failed to load. Check the URL ends with /FeatureServer/0, that the layer is shared publicly, and that field names in CONFIG.fields match your schema.`;
      }

      // ===== Feature count pill for reports =====
      const countPill = document.getElementById('countPill');
      function updateCount() {
        if (!reportsLayer.loaded) return;
        const q = reportsLayer.createQuery();
        q.where = reportsLayer.definitionExpression || "1=1";
        q.returnGeometry = false; q.outFields = [];
        reportsLayer.queryFeatureCount(q).then(n => countPill.textContent = n + " features");
      }

      // Log actual fields & enable Apply when ready
      const applyBtn = document.getElementById('applyBtn');
      applyBtn.disabled = true;
      reportsLayer.when(() => {
        try { console.table(reportsLayer.fields.map(f=>({name:f.name, type:f.type}))); } catch(_) {}
        updateCount();
        applyBtn.disabled = false;
      });

      // ===== Filters =====
      const typeSel = document.getElementById('typeSel');
      const statusSel = document.getElementById('statusSel');
      const dateSel = document.getElementById('dateSel');

      document.getElementById('applyBtn').addEventListener('click', () => {
        const parts = [];
        if (typeSel.value)   parts.push(`${CONFIG.fields.type} = '${typeSel.value}'`);
        if (statusSel.value) parts.push(`${CONFIG.fields.status} = '${statusSel.value}'`);
        if (dateSel.value) {
          const d = new Date(dateSel.value);
          if (CONFIG.fields.created.toLowerCase() === "creationdate") {
            const start = d.getTime(), end = start + 24*60*60*1000;
            parts.push(`${CONFIG.fields.created} BETWEEN ${start} AND ${end}`);
          } else {
            parts.push(`${CONFIG.fields.created} >= DATE '${dateSel.value}'`);
          }
        }
        reportsLayer.definitionExpression = parts.join(" AND ") || null;
        updateCount();
        hideStatus();
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        typeSel.value = ""; statusSel.value = ""; dateSel.value = "";
        reportsLayer.definitionExpression = null;
        updateCount();
        hideStatus();
      });

      // Zoom to reports extent (if any)
      view.whenLayerView(reportsLayer).then(() => {
        reportsLayer.queryExtent().then((res) => { if (res.extent) view.goTo(res.extent.expand(1.2)).catch(()=>{}); });
      }).catch((e)=>{ showStatus("Could not create a layer view for Field Reports. If this layer is private, share it with Everyone or sign in.", 'error'); console.error("Reports layerView error:", e); });

      // ===== Compact square visibility switcher (FR / NOV / NWS) =====
      const vis = document.createElement('div');
      vis.className = 'vis-switch';
      vis.innerHTML = `
        <button id="btnFR"  title="Field Reports">FR</button>
        <button id="btnNOV" title="NOVEC Territory">NOV</button>
        <button id="btnNWS" title="NWS Alerts">NWS</button>
      `;
      // place inside the map so it sits beside default zoom
      document.getElementById('viewDiv').appendChild(vis);

      const btnFR = vis.querySelector('#btnFR');
      const btnNOV = vis.querySelector('#btnNOV');
      const btnNWS = vis.querySelector('#btnNWS');

      function syncButtons(){
        btnFR.classList.toggle('on',  reportsLayer.visible);
        btnNOV.classList.toggle('on', novec.visible);
        btnNWS.classList.toggle('on', nwsAlerts.visible);
      }
      btnFR.addEventListener('click', ()=>{ reportsLayer.visible = !reportsLayer.visible; syncButtons(); });
      btnNOV.addEventListener('click', ()=>{ novec.visible       = !novec.visible;       syncButtons(); });
      btnNWS.addEventListener('click', ()=>{ nwsAlerts.visible    = !nwsAlerts.visible;    syncButtons(); });
      // initial state
      syncButtons();

      // ===== NOAA point forecast on click =====
      const wxSummary = document.getElementById("wxSummary");
      view.on("click", async (e) => {
        try {
          wxSummary.textContent = "Fetching NOAA point forecast‚Ä¶";
          const { longitude, latitude } = e.mapPoint;
          const meta = await fetch(`https://api.weather.gov/points/${latitude.toFixed(4)},${longitude.toFixed(4)}`).then(r => r.json());
          const forecastUrl = meta?.properties?.forecast || meta?.properties?.forecastHourly;
          if (!forecastUrl) throw new Error("No forecast URL for this point.");
          const fcst = await fetch(forecastUrl).then(r => r.json());
          const p = fcst?.properties?.periods?.[0];
          wxSummary.innerHTML = p
            ? `<div style="font-weight:600">${p.name || "Forecast"}</div>
               <div style="margin-top:4px">${p.detailedForecast || p.shortForecast}</div>
               <div class="note" style="margin-top:6px">Temp: ${p.temperature}¬∞${p.temperatureUnit} ‚Ä¢ Wind: ${p.windSpeed} ${p.windDirection}</div>`
            : "No forecast periods found for this location.";
        } catch (err) {
          wxSummary.textContent = "NOAA request failed. If blocked, we can add a tiny proxy service.";
          console.error(err);
        }
      });
    });
  </script>
</body>
</html>
